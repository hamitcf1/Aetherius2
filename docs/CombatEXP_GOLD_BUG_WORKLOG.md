Investigation & Work Log — CombatEXP_GOLD_BUG

Date: 2026-01-15
Author: automated test / code scan

Summary
- Reproduced the reward application path in the codebase and confirmed the flow:
  - Rewards are generated by `services/lootService.finalizeLoot()` and include `xp`, `gold`, and a generated `transactionId`.
  - Inventory updates are applied via `onInventoryUpdate` (which calls `handleGameUpdate({ newItems })`).
  - Combat victory triggers `handleGameUpdate({ xpChange, goldChange, transactionId })` to apply rewards to the active character.

Findings
- The Transaction Ledger (services/transactionLedger.ts) is responsible for de-duplicating transactionIDs and recording applied transactions.
- `TransactionLedger.recordTransaction` silently NO-OPs when no character context is set (it checks `this.characterId` and returns early). If the ledger isn't given the active character id, transactions won't be recorded, weakening duplicate detection and telemetry.

Work Completed (PR-ready changes)
1. Added unit test: `tests/combat-rewards.spec.ts`
   - Verifies `finalizeLoot` returns rewards with `transactionId` and that applying the update via `filterDuplicateTransactions` records the transaction (when the transaction ledger has a character set) and updates character values.

2. Added a safety hook in `App.tsx`:
   - A `useEffect` now calls `getTransactionLedger().setCharacter(currentCharacterId)` whenever `currentCharacterId` changes. This ensures the ledger can record the transactions generated on combat reward application.

3. Added critical persistence & telemetry (this PR)
   - Implemented `saveCharacterWithRetry(uid, character, { retries, baseDelayMs })` in `services/firestore.ts` (exponential backoff + jitter).
   - Added lightweight telemetry calls (using `services/logger`) when rewards are applied (includes `uid`, `charId`, `combatId`, `transactionId`, `gold`, `xp`, `timestamp`).
   - On combat victory, `App.tsx` now attempts immediate persistence of the updated character using `saveCharacterWithRetry` and logs success/failure; if offline, it queues the character save.

Observed behavior after changes
- Unit tests pass locally for the newly added tests.
- Integration test `tests/integration/combat-persistence.spec.tsx` was added to validate the end-to-end apply -> persist path; it requires mocking auth/firestore and can be flaky due to environment startup ordering (I added defensive guards and logs). It verifies HUD update and that `saveCharacterWithRetry` is invoked with updated gold/xp.

Next steps
- Stabilize and extend the integration test to run reliably in CI (use Firestore emulator or more robust mocks to avoid timing flakiness).
- Add minimal telemetry metrics/counters for: reward apply attempts, save success, save failure — surface to logs/monitoring.
- Optionally surface a user-visible error/notification if persistence fails repeatedly (after retries) for critical operations like combat rewards.

Notes
- I made `audioService` localStorage access defensive so tests don't fail during initialization when environment setup order differs.
- If you'd like, I can now harden the integration test (use Firestore emulator with `initializeFirestoreDb`) and add an e2e smoke test to the CI pipeline.
If you want, I can proceed to add the integration test and small telemetry events next.