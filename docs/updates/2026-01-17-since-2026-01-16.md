# Change report ‚Äî 2026-01-16 ‚Üí 2026-01-17

Scope: bug fixes, UX hardening, persistence fixes, content additions, and tests across combat, companions, spells, equipment, and shop/loot.

Generated: 2026-01-17

---

## Executive summary ‚úÖ
- Work since yesterday focused on combat/companion correctness, learned-spell persistence, shop/loot content, equipment bugfixes, and build stability.
- All targeted fixes implemented and covered with unit/UI tests; full dev build and local worker start are green.
- Recommended next actions: add an E2E for learned-spell sync, playtest/tune new shop items, and monitor a remaining UI selection-order permutation.

---

## At-a-glance status
| Area | Change type | Status |
|---|---:|:---:|
| Companion targeting UX | Bugfix + UX | ‚úÖ Done ‚Äî pre-validation + toast, no invalid dice-rolls |
| companionMeta.autoControl | Invariant preservation | ‚úÖ Done |
| Summons leveling | Bugfix | ‚úÖ Done ‚Äî numeric levels enforced |
| Learned-spell persistence | Feature/bugfix | ‚úÖ Done ‚Äî local‚Üîserver merge |
| Combat UI (Actions) | UX change | ‚úÖ Done (desktop only) |
| CharacterSheet | UX indicator | ‚úÖ Done ‚Äî "Saved to cloud" badge |
| Shop & loot | Content + gating | ‚úÖ Done ‚Äî curated + level/rarity gating |
| Shield equip bug | Bugfix | ‚úÖ Done ‚Äî shields ‚Üí `offhand` |
| App.tsx parse error | Build-blocking bugfix | ‚úÖ Done ‚Äî dev build green |
| Tests | Unit + UI | ‚úÖ Done ‚Äî new/updated tests added |
| Flaky UI permutations | Hardening | ‚ö†Ô∏è Partially done ‚Äî monitor |

---

## Detailed changelog (concise) üîß

1. Companion targeting ‚Äî prevent invalid dice-rolls
   - UI pre-validates companion targets and shows toast instead of animating rolls for invalid targets.
   - Files: `components/CombatModal.tsx`, service parity in `services/combatService.ts`.
   - Tests: companion-targeting UI tests updated/added.

2. Preserve explicit `companionMeta.autoControl`
   - Normalization/rehydration keep explicit values; no silent overrides.
   - Files: normalization paths in `services/*`; companion persistence tests updated.

3. Summons: ensure valid levels
   - Conjures/summons receive a numeric level and scale with encounter/character level.
   - Files: `services/combatService.ts` and summon-creation codepaths.
   - Tests: `tests/summon-type.spec.ts`.

4. Learned-spell persistence across restarts
   - Implemented union-merge of server and local learned spells on character load; writes back to localStorage when server lacks entries.
   - Files: `services/spells.ts` (added `mergeLearnedSpellsFromCharacter`), `App.tsx` (hooked into character load).
   - Tests: `tests/spells-merge.spec.ts`, `tests/spells-storage.spec.ts`.

5. Move Combat Actions (desktop)
   - Desktop UX: "ACTIONS" panel moved under player card; mobile unchanged.
   - Files: `components/CombatModal.tsx`.

6. "Saved to cloud" indicator
   - Transient badge added to `CharacterSheet` driven by `AppContext.lastCloudSaveAt`.
   - Files: `components/CharacterSheet.tsx`, `App.tsx`.
   - Tests: `tests/character-sheet-save-indicator.spec.tsx`.

7. Shop & loot expansion
   - Added curated shop items (level-gated, rarity-balanced), matching `lootTables` entries and explicit `itemStats`.
   - Files: `components/ShopModal.tsx`, `data/lootTables.ts`, `services/itemStats.ts`.
   - Tests: `tests/shop.spec.tsx`, `tests/loot-tables.spec.ts`.

8. Shield equip bug ‚Üí offhand mapping
   - Slot inference updated so shields map to `offhand` (no longer wearable as chest armor).
   - Files: `components/EquipmentHUD.tsx`, `services/equipment.ts`.
   - Tests: `tests/equipment.spec.ts`.

9. App.tsx parsing/build blocker
   - Fixed malformed `catch` block that prevented the dev server from starting.
   - Validation: full dev build and local worker started successfully (`npm run dev:full`).

10. Tests added / updated
    - New: `spells-merge.spec.ts`, `character-sheet-save-indicator.spec.tsx`, `loot-tables.spec.ts`.
    - Updated: companion UI tests, `shop.spec.tsx`, `equipment.spec.ts`, summon tests.

---

## Validation & rollout ‚úÖ
- Local verification: focused unit + UI tests passing; full dev build succeeded.
- How to reproduce locally:
  - Start dev: `npm run dev` or `npm run dev:full`
  - Run focused tests: `npm test -- -t spells-merge`
- Migration safety: no storage-key format changes; existing `aetherius:simulation:` keys preserved.

---

## Risks, remaining work & recommendations ‚ö†Ô∏è
- High priority follow-ups
  1. Add an E2E that simulates server restart + cross-device learned-spell sync (High).
  2. Playtest & tune new shop item drop rates/prices (Medium).
- Monitor: selection-order UI permutations ‚Äî previously flaky; hardened but keep under watch.
- Low-risk notes: AI/gemini integration unaffected; no storage-key changes.

---

## Recommended next steps ‚ñ∂Ô∏è
1. Merge PR after CI is green, one reviewer approval, and a short manual playtest checklist (learned-spells, summon scaling, shield equip, shop visibility).
2. Add an E2E for learned-spell sync across restart/devices.
3. Schedule a 1-hour playtest to collect balance data for shop/loot.
4. Keep the flaky-selection-order test monitored in CI for the next 2 releases.

---

## Quick changelist (for PR body)
- Key files: `App.tsx`, `components/CombatModal.tsx`, `components/CharacterSheet.tsx`, `components/EquipmentHUD.tsx`, `components/ShopModal.tsx`, `services/spells.ts`, `services/itemStats.ts`, `data/lootTables.ts`
- Tests: `spells-merge.spec.ts`, `character-sheet-save-indicator.spec.tsx`, `loot-tables.spec.ts`, updated `shop.spec.tsx`, `equipment.spec.ts`, `summon-type.spec.ts`, companion UI tests updated.

---

### PR checklist (suggested)
- [ ] CI green
- [ ] One reviewer + playtest (learned spells, summoning, shield equip, shop)
- [ ] Add E2E for learned-spell sync (follow-up PR OK)
- [ ] Merge notes: none ‚Äî backward-compatible

---

If you'd like, I can also:
- Draft the PR description & changelog entry from this file.
- Add the E2E test scaffold for learned-spell sync in a new branch.


---
*Report generated by tooling in-repo ‚Äî keep this file with the PR for reviewer context.*
